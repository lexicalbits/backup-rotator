#!/usr/bin/env php
<?php
require 'vendor/autoload.php';

use LexicalBits\BackupRotator\StreamChunker;
use LexicalBits\BackupRotator\Storage\Storage;
use LexicalBits\BackupRotator\Logging;

$config = parse_ini_file('./config.ini', true);
Logging::setPath($config['logging']['path']);
$storage = Storage::factory($config['storage']);

$chunker = new StreamChunker("php://stdin", function (string $data, int $idx) use ($storage) {
    $storage->onChunk($data, $idx);
}, $storage::CHUNK_SIZE_KB, $config['storage']['maxkb']);

$chunker->run();
$storage->onEnd();
